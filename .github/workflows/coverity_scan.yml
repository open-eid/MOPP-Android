name: Coverity scan

on: [push, pull_request]
jobs:
  coverity:
    name: Run Coverity tests
    if: contains(github.repository, 'open-eid/MOPP-Android') && contains(github.ref, 'coverity_scan')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Install sdkman
        run: curl -s "https://get.sdkman.io" | bash
      - name: Install gradle
        run:  source "$HOME/.sdkman/bin/sdkman-init.sh" && sdk list gradle && sdk install gradle 5.5
      - name: Build and send to Coverity
        run: |
          export TRAVIS_BRANCH=${GITHUB_REF##*/}
          wget -O - https://scan.coverity.com/scripts/travisci_build_coverity_scan.sh | bash
        env:
          COVERITY_SCAN_PROJECT_NAME: 'open-eid/MOPP-Android'
          COVERITY_SCAN_NOTIFICATION_EMAIL: 'eid-teenusehaldus@ria.ee'
          COVERITY_SCAN_BRANCH_PATTERN: 'coverity_scan'
          COVERITY_SCAN_BUILD_COMMAND_PREPEND: 'gradle -S clean'
          COVERITY_SCAN_BUILD_COMMAND: 'gradle -S app:assembleDebug -x app:processDebugGoogleServices -x app:uploadCrashlyticsMappingFileDebug'
          COVERITY_SCAN_TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
